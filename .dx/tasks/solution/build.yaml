---
- name: Remove artifacts
  ansible.builtin.file:
    path: "{{ solutions_dir }}/target"
    state: absent

- name: Create directories
  ansible.builtin.file:
    path: "{{ solutions_dir }}/target/context"
    state: directory
    recurse: true

- name: Capture env
  ansible.builtin.include_vars:
    file: ../envs/ops/{{ opsenv }}.yaml
    name: ops

- name: Build conf
  ansible.builtin.template:
    src: "{{ solutions_dir }}/props/{{ ops.config_file_name.source }}"
    dest: "{{ solutions_dir }}/target/context/{{ ops.config_file_name.target }}"
    mode: "644"
  vars:
    database_name: "{{ project }}"
    owner_name: "{{ project }}"
    owner_password: "{{ project }}"

- name: Build spec
  ansible.builtin.command:
    cmd: >
      docker compose
      --project-name {{ project }}
      --file usecases/basis.yaml
      --file usecases/{{ usecase }}.yaml
      --profile {{ opsenv }}
      config
      --output target/context/compose.yaml
      --no-path-resolution
    strip_empty_ends: false
    chdir: "{{ solutions_dir }}"
  environment:
    DATABASE_NAME: "{{ project }}"
    SCHEMA_NAME: "sepulkarium"
    OWNER_NAME: "{{ project }}"
    OWNER_PASSWORD: "{{ project }}"
    POSTGRES_VERSION: "{{ ops.postgres_version }}"
    SCHEMA_TAG: "{{ schema_cids.postgres }}"
    SCHEMA_IMAGE: "{{ schema_images.postgres }}"
    APP_TAG: "{{ hostvars.app.image_cids['sepuling-' ~ ops.sepuling.lang_mode][:7] }}-{{ devenv }}"
    APP_IMAGE: "{{ app_images['sepuling-' ~ ops.sepuling.lang_mode] }}"
    CONFIG_FILE_NAME: "{{ ops.config_file_name.target }}"
    CONFIG_MAPPING_MODE: "{{ ops.config_mapping_mode }}"
  changed_when: true
