---
- name: Binaries
  hosts: lib
  run_once: true
  tasks:
    - name: Capture status
      ansible.builtin.command:
        # todo: try to implement more lightweight check
        cmd: >
          mvn
          {% if binary_repo == 'local' %}
          --offline
          {% else %}
          --define remoteRepositories=github::::https://{{ binary_repo }}/smecalculus/bezmen
          {% endif %}
          dependency:get
          --define transitive=false
          --define artifact=org.smecalculus.bezmen:libs:{{ lib_version }}:pom
        chdir: "{{ playbook_dir }}/../libs"
      register: binary_status
      changed_when: binary_status.rc != 0
      failed_when: false
    - name: Status command
      ansible.builtin.debug:
        msg: "{{ binary_status.cmd|join(' ') }}"
      when: binary_status is changed
    - name: Test and create binaries
      ansible.builtin.command:
        cmd: >
          mvn
          --no-snapshot-updates
          --fail-fast
          --batch-mode
          --threads 2C
          --define revision={{ lib_version }}
          clean
          {% if focus == 'solution' %}
          deploy
          {% else %}
          install
          {% endif %}
        chdir: "{{ playbook_dir }}/../libs"
      changed_when: true
      when: binary_status is changed

- name: Binaries
  hosts: app
  run_once: true
  tasks:
    - name: Capture cid
      ansible.builtin.command:
        cmd: git hash-object --stdin
        stdin: |
          {{ lib_cid }}
          {{ app_cid }}
      # TODO: try to choose better name
      register: image_cid
      changed_when: false
      tags: [always]
    - name: Capture statuses
      ansible.builtin.command:
        cmd: docker {{ docker_entity }} inspect {{ item.value }}:{{ image_cid.stdout[:7] }}
      register: image_status
      changed_when: image_status.rc != 0
      failed_when: false
      loop: "{{ app_images|dict2items }}"
      loop_control:
        label: "{{ item.key }}"
      tags: [always]
    - name: Status commands
      ansible.builtin.debug:
        msg: "{{ image_status.results|map(attribute='cmd')|map('join', ' ') }}"
      when: image_status is changed
      tags: [always]
    - name: Test units and create binaries
      ansible.builtin.command:
        cmd: >
          mvn
          --no-snapshot-updates
          --fail-fast
          --batch-mode
          --threads 2C
          {% if not hostvars.lib.binary_status|default({}) is changed %}
          --projects {{ image_status.results|select('changed')|map(attribute='item.key')|join(',') }}
          {% endif %}
          --define revision={{ app_version }}
          --define lib.version={{ lib_version }}
          clean
          package
        chdir: "{{ playbook_dir }}/../apps"
        strip_empty_ends: false
      changed_when: true
      when: image_status is changed

- name: Coverage
  hosts: tool
  run_once: true
  tasks:
    - name: Generate reports
      ansible.builtin.command:
        cmd: >
          mvn
          --no-snapshot-updates
          --batch-mode
          clean
          antrun:run@units
          antrun:run@integrations
          antrun:run@overall
        chdir: "{{ playbook_dir }}/../.tools"
        strip_empty_ends: false
      changed_when: true
      when: >
        hostvars.lib.binary_status|default({}) is changed or
        hostvars.app.image_status|default({}) is changed
