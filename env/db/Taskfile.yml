version: '3'

vars:
  USAGE: toy
  VENDOR: postgres
  ENV_DB_REVISION:
    sh: git write-tree --prefix=env/db
  ENV_DB_REV: '{{.ENV_DB_REVISION | trunc 7 }}'

tasks:
  empty:
    desc: create empty database for specific usage
    vars:
      NAME: '{{.USAGE}}-{{.VENDOR}}-{{.ENV_DB_REV }}'
    status:
      - '$(docker container inspect -f {{"{{.State.Running}}"}} {{.NAME}})'
    dir: src
    cmds:
      - cmd: docker rm -f $(docker ps -aq -f name={{.USAGE}}-{{.VENDOR}}*) 2> /dev/null
        ignore_error: true
      - cmd: ansible-playbook db.yml -i toy -e container_name={{.NAME}}
      - task: ::lib:schema:reset
