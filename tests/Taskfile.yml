version: '3'

set: [pipefail]

vars:
  TEST_REVISION:
    sh: git write-tree --prefix=tests
  TEST_REV: '{{.TEST_REVISION | trunc 7}}'

includes:
  integration:
    taskfile: integration/Taskfile.yml
    dir: integration
  system:
    taskfile: system/Taskfile.yml
    dir: system

tasks:
  binary:
    run: once
    status:
      - test -f target/pom-resolved-{{.TEST_REV}}.xml
    deps:
      - task: :app:binary
    cmds:
      - find . -name "pom-resolved*.xml" -type f -delete
      - mvn package -am -T1C -Drevision={{.TEST_REV}}
