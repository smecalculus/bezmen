version: '3'

set: [ pipefail ]

includes:
  toy:
    taskfile: system/Taskfile.toy.yml
    dir: system
  func:
    taskfile: system/Taskfile.func.yml
    dir: system

vars:
  TEST_REVISION:
    sh: git write-tree --prefix=tests
  TEST_CID: '{{.TEST_REVISION | trunc 7}}'

tasks:
  binaries:
    run: once
    cmds:
      - task: system:binary
  image:
    run: when_changed
    vars:
      COMMAND: '{{if eq .REGISTRY "localhost"}}inspect{{else}}pull{{end}}'
      TEST_TYPE: '{{.TEST_TYPE | default .USAGE}}'
      TEST_IMAGE: '{{.PROJECT_REPO}}/{{.PROJECT}}-test-{{.TEST_TYPE}}'
      TEST_REF: '{{.TEST_IMAGE}}:{{.TEST_CID}}'
    status:
      - docker image {{.COMMAND}} {{.TEST_REF}}
      - '{{.LIB_BINARIES_STATUS}}'
    cmds:
      # deps
      - task: :lib:binaries
      # cmds
      - task: :docker:image:reset
        vars:
          DOCKER_IMAGE: '{{.TEST_IMAGE}}'
      - cmd: >
          docker build .
          -f Dockerfile
          -t {{.TEST_REF}}
          --build-arg TEST_TYPE={{.TEST_TYPE}}
      - task: :docker:image:push
        vars:
          DOCKER_IMAGE: '{{.TEST_REF}}'
  run:
    cmds:
      # deps
      - task: image
      # actions
      - cmd: >
          mvn clean test
          --batch-mode
          -Dlibs.version={{.LIBS_VERSION}}
          -Dtests.type={{.USAGE | title}}
          -Dprops.combo={{.PROPS}}
          {{.CLI_ARGS}}
    dir: system
