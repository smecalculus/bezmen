version: '3'

set: [ pipefail ]

includes:
  toy:
    taskfile: toy/Taskfile.yml
    dir: toy
  func:
    taskfile: func/Taskfile.yml
    dir: func

vars:
  # toy
  TEST_TOY_REVISION:
    sh: git write-tree --prefix=tests/toy
  TEST_TOY_CID: '{{.TEST_TOY_REVISION | trunc 7}}'
  TEST_TOY_IMAGE: '{{.PROJECT_REPO}}/{{.PROJECT_NAME}}-test-toy'
  TEST_TOY_REF: '{{.TEST_TOY_IMAGE}}:{{.TEST_TOY_CID}}'
  # func
  TEST_FUNC_REVISION:
    sh: git write-tree --prefix=tests/func
  TEST_FUNC_CID: '{{.TEST_FUNC_REVISION | trunc 7}}'
  TEST_FUNC_IMAGE: '{{.PROJECT_REPO}}/{{.PROJECT_NAME}}-test-func'
  TEST_FUNC_REF: '{{.TEST_FUNC_IMAGE}}:{{.TEST_FUNC_CID}}'
  # usage
  TEST_USAGE_REFS: >
    {{- if eq .USAGE "toy" -}}
      {{.TEST_TOY_REF}}
    {{- else if eq .USAGE "func" -}}
      {{.TEST_FUNC_REF}}
    {{- else -}}
      {{fail}}
    {{- end -}}

tasks:
  binaries:
    run: once
    internal: true
    cmds:
      - cmd: >
          mvn clean install
          -am -T1C
  images:
    run: once
    internal: true
    cmds:
      - task: :test:toy:image
      - task: :test:func:image
  run:
    cmds:
      - task: :lib:binaries
      - task: :test:{{.USAGE}}:image
      - cmd: >
          mvn clean test
          --projects {{.USAGE}}
          --batch-mode
          -Dlibs.version={{.LIB_VERSION}}
          -Dprops.combo={{.PROPS}}
          {{.CLI_ARGS}}
