version: '3'

set: [ pipefail ]

includes:
  toy:
    taskfile: toy/Taskfile.yml
    dir: toy
  func:
    taskfile: func/Taskfile.yml
    dir: func

vars:
  TEST_REVISION:
    sh: git write-tree --prefix=tests
  TEST_CID: '{{.TEST_REVISION | trunc 7}}'
  TEST_X_REF: '{{.PROJECT_REPO}}/{{.PROJECT_NAME}}-test-{{.USAGE}}:{{.TEST_CID}}'

tasks:
  binaries:
    run: once
    internal: true
    cmds:
      - cmd: >
          mvn clean install
          -am -T1C
  images:
    run: once
    internal: true
    cmds:
      - task: :test:toy:image
      - task: :test:func:image
  run:
    cmds:
      - task: :lib:binaries
      - task: :test:{{.USAGE}}:image
      - cmd: >
          mvn clean test
          --projects {{.USAGE}}
          --batch-mode
          -Dlibs.version={{.LIBS_VERSION}}
          -Dprops.combo={{.PROPS}}
          {{.CLI_ARGS}}
