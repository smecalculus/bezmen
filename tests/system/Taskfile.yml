version: '3'

set: [pipefail]

vars:
  TEST_SYSTEM_STAGE: system
  TEST_SYSTEM_REVISION:
    sh: git write-tree --prefix=tests/system
  TEST_SYSTEM_REV: '{{.TEST_SYSTEM_REVISION | trunc 7}}'

tasks:
  run:
    run: once
    vars:
      COMMAND: '{{if eq .REGISTRY "localhost"}}inspect{{else}}pull{{end}}'
    status:
      - docker image {{.COMMAND}} {{.APP_FOO_REF}}-{{.TEST_SYSTEM_STAGE}}
      - docker image {{.COMMAND}} {{.SCHEMA_REF}}-{{.TEST_SYSTEM_STAGE}}
    cmds:
      # deps
      - task: ::stand:toy:mk
      # actions
      - cmd: mvn test
      # proofs
      - task: approve
  approve:
    run: once
    internal: true
    cmds:
      - docker tag {{.SCHEMA_REF}} {{.SCHEMA_REF}}-{{.TEST_SYSTEM_STAGE}}
      - docker tag {{.APP_FOO_REF}} {{.APP_FOO_REF}}-{{.TEST_SYSTEM_STAGE}}
  publish:
    run: once
    preconditions:
      - sh: '[ "{{.REGISTRY}}" != "localhost" ]'
    cmds:
      - docker push {{.SCHEMA_REF}}-{{.TEST_SYSTEM_STAGE}}
      - docker push {{.APP_FOO_REF}}-{{.TEST_SYSTEM_STAGE}}
