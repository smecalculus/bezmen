version: '3'

set: [pipefail]

vars:
  LIB_SCHEMA_DIR: src/main/resources/{{.ENV_DB_VENDOR}}
  LIB_SCHEMA_REVISION:
    sh: git write-tree --prefix=libs/schema/{{.LIB_SCHEMA_DIR}}
  LIB_SCHEMA_CID: '{{.LIB_SCHEMA_REVISION | trunc 7}}'
  LIB_SCHEMA_IMAGE: '{{.PROJECT_REPO}}/{{.PROJECT_NAME}}-schema-{{.ENV_DB_VENDOR}}'
  LIB_SCHEMA_REF: '{{.LIB_SCHEMA_IMAGE}}:{{.LIB_SCHEMA_CID}}'

tasks:
  image:
    run: once
    vars:
      COMMAND: '{{if eq .REGISTRY "localhost"}}inspect{{else}}pull{{end}}'
    status:
      - docker image {{.COMMAND}} {{.LIB_SCHEMA_REF}}
    dir: '{{.LIB_SCHEMA_DIR}}'
    cmds:
      - task: ::docker:image:reset
        vars:
          IMAGE: '{{.LIB_SCHEMA_IMAGE}}'
      - cmd: docker build . -t {{.LIB_SCHEMA_REF}}
      - task: ::docker:image:push
        vars:
          REF: '{{.LIB_SCHEMA_REF}}'
