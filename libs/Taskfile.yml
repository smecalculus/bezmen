version: '3'

set: [pipefail]

vars:
  LIB_REVISION:
    sh: git write-tree --prefix=libs
  LIB_CID: '{{.LIB_REVISION | trunc 7}}'
  LIB_VERSION: 0.1.0-{{.LIB_CID}}
  LIB_BINARIES_STATUS: >
    {{if eq .REGISTRY "localhost" -}}
      task --dir {{.ROOT_DIR}} --status lib:binaries
    {{- else -}}
      true
    {{- end -}}

tasks:
  code:
    run: once
    cmds:
      - mvn spotless:apply -Drevision={{.LIB_VERSION}}
  binaries:
    run: once
    status:
      - mvn --offline dependency:get -Dartifact=org.smecalculus.bezmen:libs:{{.LIB_VERSION}}:pom
    cmds:
      - cmd: >
          mvn clean install
          --threads 2C
          --batch-mode
          -Drevision={{.LIB_VERSION}}
          -DskipTests=true
  units:
    run: once
    cmds:
      - cmd: >
          mvn clean test
          --threads 2C
          --batch-mode
          -Drevision={{.LIB_VERSION}}
  integrations:
    run: once
    cmds:
      - cmd: >
          mvn clean verify
          --threads 2C
          --batch-mode
          -Drevision={{.LIB_VERSION}}
          -DskipUnitTests=true
  images:
    run: once
