version: '3'

set: [pipefail]

tasks:
  reset:
    run: once
    cmds:
      - docker rm -f $(docker ps -aq)
      - docker image prune -f
      - docker network prune -f
      - docker volume rm $(docker volume ls -q -f dangling=true)
  image:reset:
    run: when_changed
    internal: true
    vars:
      IMAGE: '{{.IMAGE}}'
    cmds:
      - cmd: docker container rm -f $(docker ps -aq -f label=bezmen.image={{.IMAGE}})
        ignore_error: true
      - cmd: docker image rm -f $(docker images -q -f reference={{.IMAGE}})
        ignore_error: true
  image:push:
    run: when_changed
    internal: true
    vars:
      REF: '{{.REF}}'
    cmds:
      - cmd: >
          {{- if eq .REGISTRY "localhost" -}}
            true
          {{- else -}}
            docker {{.ENTITY}} push {{.REF}}
          {{- end -}}
  image:tag:
    run: when_changed
    internal: true
    vars:
      OLD: '{{.OLD}}'
      NEW: '{{.NEW}}'
    cmds:
      - cmd: >
          {{- if eq .REGISTRY "localhost" -}}
            docker image tag {{.OLD}} {{.NEW}}
          {{- else -}}
            docker manifest create {{.NEW}} {{.OLD}}
          {{- end -}}
