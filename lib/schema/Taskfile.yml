version: '3'

set: [pipefail]

vars:
  VENDOR: postgres
  IMAGE: schema-{{.VENDOR}}
  REGISTRY: '{{.REGISTRY | default "localhost" }}'
  APP_SCHEMA_REVISION:
    sh: git write-tree --prefix=lib/schema/{{.VENDOR}}
  APP_SCHEMA_REV: '{{.APP_SCHEMA_REVISION | trunc 7 }}'

tasks:
  image-1:
    desc: create binary artifact
    preconditions:
      - sh: '[ "{{.REGISTRY}}" = "localhost" ]'
    status:
      - docker image inspect {{.IMAGE}}:{{.APP_SCHEMA_REV}}
    cmds:
      - task: reset
      - cmd: docker rmi -f $(docker images -q --filter reference={{.IMAGE}}*) 2> /dev/null
        ignore_error: true
      - cmd: docker build . -t {{.IMAGE}}:{{.APP_SCHEMA_REV}}
    dir: '{{.VENDOR}}'
  image-2:
    desc: create binary artifact
    preconditions:
      - sh: '[ "{{.REGISTRY}}" != "localhost" ]'
    vars:
      NAME: '{{.REGISTRY}}/smecalculus/{{.IMAGE}}:{{.APP_SCHEMA_REV}}'
    status:
      - docker pull {{.NAME}}
    cmds:
      - docker build . -t {{.NAME}}
      - docker push {{.NAME}}
    dir: '{{.VENDOR}}'
  dba:
    desc: create dba objects
    vars:
      NAME: '{{.VENDOR}}-dba-{{.APP_SCHEMA_REV}}'
    status:
      - 'exit $(docker container inspect -f {{"{{.State.ExitCode}}"}} {{.NAME}} || echo 42)'
    deps:
      - task: image-1
      - task: ::env:db:empty
    cmds:
      - task: reset
      - cmd: >
          docker run
          --name {{.NAME}}
          --net host
          --label ancestor={{.IMAGE}}
          {{.IMAGE}}:{{.APP_SCHEMA_REV}}
          --show-banner=false
          --changelog-file=dba/changelog.yml
          --url=jdbc:postgresql://localhost:5432/bezmen?currentSchema=public
          --liquibase-schema-name=public
          --username=postgres
          --password=password
          --labels=user,schema
          update
          -Dbezmen.schema=bezmen
          -Dbezmen.owner=bezmen
          -Dbezmen.password=bezmen
  owner:
    desc: create owner objects
    vars:
      NAME: '{{.VENDOR}}-owner-{{.APP_SCHEMA_REV}}'
    status:
      - 'exit $(docker container inspect -f {{"{{.State.ExitCode}}"}} {{.NAME}} || echo 42)'
    deps:
      - task: dba
    cmds:
      - cmd: docker rm -f $(docker ps -aq -f name={{.VENDOR}}-owner*) 2> /dev/null
        ignore_error: true
      - cmd: >
          docker run
          --name {{.NAME}}
          --net host
          --label ancestor={{.IMAGE}}
          {{.IMAGE}}:{{.APP_SCHEMA_REV}}
          --show-banner=false
          --changelog-file=owner/changelog.yml
          --url=jdbc:postgresql://localhost:5432/bezmen?currentSchema=bezmen
          --liquibase-schema-name=bezmen
          --username=bezmen
          --password=bezmen
          update
  reset:
      - cmd: docker rm -f $(docker ps -aq -f label=ancestor={{.IMAGE}}) 2> /dev/null
        ignore_error: true
