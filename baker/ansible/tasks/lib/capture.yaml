---
- name: Capture CID's
  ansible.builtin.command:
    cmd: git hash-object --stdin
    stdin: |
      {% for lib in product.libs %}
      {{ lookup('ansible.builtin.pipe', 'git write-tree --prefix=lib/' ~ lib.name) }}
      {% endfor %}
  register: binary_cid
  changed_when: false

- name: Declare tag
  ansible.builtin.set_fact:
    binary_tag: "{{ devenv }}-{{ binary_cid.stdout[:7] }}"
  changed_when: false

- name: Capture status
  ansible.builtin.command:
    cmd: >-
      mvn dependency:copy@capture
        --projects :lib
      {% if repo_mode == 'n/a' %}
        --offline
      {% else %}
        --define remoteRepositories=github::::https://{{ binary_repo }}/{{ project.org }}/{{ project.name }}
      {% endif %}
        --define revision={{ binary_tag }}
    chdir: "{{ project.dir }}"
  register: binary_status
  failed_when: false
  changed_when:
    - binary_status.rc != 0
